<!doctype html><html lang=id-id><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Encountered a critical memory leak issue while handling IPv6 hosts in [subping](https://github.com/fadhilyori/subping). Investigating the problem's impact on performance, stability, and scalability. Conducting benchmark tests to identify the root cause and develop an optimized solution for stable and efficient handling of IPv6 hosts."><title>Addressing the Memory Leak Bug in My Personal Project (subping)</title><link rel=canonical href=https://fadhilyori.my.id/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Addressing the Memory Leak Bug in My Personal Project (subping)"><meta property="og:description" content="Encountered a critical memory leak issue while handling IPv6 hosts in [subping](https://github.com/fadhilyori/subping). Investigating the problem's impact on performance, stability, and scalability. Conducting benchmark tests to identify the root cause and develop an optimized solution for stable and efficient handling of IPv6 hosts."><meta property="og:url" content="https://fadhilyori.my.id/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/"><meta property="og:site_name" content="Fadhil Yori Hibatullah"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="network"><meta property="article:tag" content="ping"><meta property="article:tag" content="scanning"><meta property="article:published_time" content="2023-07-06T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-06T00:00:00+00:00"><meta property="og:image" content="https://fadhilyori.my.id/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/cover.jpg"><meta name=twitter:site content="@fadhilyori"><meta name=twitter:creator content="@fadhilyori"><meta name=twitter:title content="Addressing the Memory Leak Bug in My Personal Project (subping)"><meta name=twitter:description content="Encountered a critical memory leak issue while handling IPv6 hosts in [subping](https://github.com/fadhilyori/subping). Investigating the problem's impact on performance, stability, and scalability. Conducting benchmark tests to identify the root cause and develop an optimized solution for stable and efficient handling of IPv6 hosts."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fadhilyori.my.id/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/cover.jpg"><link rel="shortcut icon" href=favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-146828802-2","auto"),ga("send","pageview"))</script></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=https://fadhilyori.my.id class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Kembali</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/><img src=/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/cover_hu3d03a01dcc18bc5be0e67db3d8d209a6_3442997_800x0_resize_q75_box.jpg srcset="/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/cover_hu3d03a01dcc18bc5be0e67db3d8d209a6_3442997_800x0_resize_q75_box.jpg 800w, /p/addressing-the-memory-leak-bug-in-my-personal-project-subping/cover_hu3d03a01dcc18bc5be0e67db3d8d209a6_3442997_1600x0_resize_q75_box.jpg 1600w" width=800 height=533 loading=lazy alt="Featured image of post Addressing the Memory Leak Bug in My Personal Project (subping)"></a></div><div class=article-details><header class=article-category><a href=/categories/writeup/>writeup</a>
<a href=/categories/note/>note</a></header><h2 class=article-title><a href=/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/>Addressing the Memory Leak Bug in My Personal Project (subping)</a></h2><h3 class=article-subtitle>Encountered a critical memory leak issue while handling IPv6 hosts in [subping](https://github.com/fadhilyori/subping). Investigating the problem's impact on performance, stability, and scalability. Conducting benchmark tests to identify the root cause and develop an optimized solution for stable and efficient handling of IPv6 hosts.</h3><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jul 06, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>Waktu Membaca: 8 menit</time></div></footer></div></header><section class=article-content><h1 id=addressing-the-memory-leak-bug-in-my-personal-project-subping>Addressing the Memory Leak Bug in My Personal Project (subping)</h1><blockquote><p><strong>Author</strong>: <a class=link href=https://github.com/fadhilyori target=_blank rel=noopener>Fadhil Yori</a><br><strong>Project</strong>: <a class=link href=https://github.com/fadhilyori/subping target=_blank rel=noopener>https://github.com/fadhilyori/subping</a><br><strong>Related Issue</strong>: <a class=link href=https://github.com/fadhilyori/subping/issues/23 target=_blank rel=noopener>https://github.com/fadhilyori/subping/issues/23</a></p></blockquote><h1 id=background>Background</h1><p>During the development process of <a class=link href=https://github.com/fadhilyori/subping target=_blank rel=noopener>subping</a>, our team encountered a critical issue involving a memory leak that specifically occurs when handling a substantial number of <a class=link href=https://en.wikipedia.org/wiki/IPv6_address target=_blank rel=noopener>IPv6</a> hosts. This memory leak has a negative impact on the application&rsquo;s performance and raises concerns regarding its stability and scalability.</p><p>We have observed that the leak becomes more pronounced as the number of IPv6 hosts increases. This observation has led us to investigate the intricacies of IPv6 host handling and its impact on memory management within the application. The significant increase in memory consumption under these conditions indicates the presence of a memory leak. Extensive testing and simulations have confirmed the intensity of the leak and its direct correlation with the workload. As a result, we have undertaken a focused investigation into the complex dynamics between IPv6 host handling and memory management. Armed with this knowledge, we have embarked on developing an optimized solution to ensure the stability and efficiency of subping.</p><p>To gain further insights and effectively address this issue, we have initiated a comprehensive benchmark test. This test aims to evaluate the application&rsquo;s performance under various scenarios, with a specific focus on monitoring memory usage during the processing of IPv6 hosts. Through this benchmark test, our objective is to uncover patterns and behaviors that will help us identify the root cause of the memory leak.</p><p>Our ultimate goal is to ensure a stable and efficient solution for handling IPv6 hosts within the subping application.</p><h1 id=main-problem>Main Problem</h1><p>The following code snippet demonstrates a function called <strong>GenerateIPListFromCIDR</strong> that generates a list of IP addresses within a specified range using CIDR notation. However, careful examination reveals a memory leak in the implementation, which can lead to inefficient memory usage over time.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// GenerateIPListFromCIDR generates a list of IP addresses within the specified range
</span></span></span><span class=line><span class=cl><span class=c1>// based on the given CIDR notation.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GenerateIPListFromCIDR</span><span class=p>(</span><span class=nx>cidr</span> <span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>IPNet</span><span class=p>)</span> <span class=p>[]</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>ips</span> <span class=p>[]</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>firstIP</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cidr</span><span class=p>.</span><span class=nx>IP</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nb>copy</span><span class=p>(</span><span class=nx>firstIP</span><span class=p>,</span> <span class=nx>cidr</span><span class=p>.</span><span class=nx>IP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>cidr</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>firstIP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>newIP</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>firstIP</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nb>copy</span><span class=p>(</span><span class=nx>newIP</span><span class=p>,</span> <span class=nx>firstIP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>ips</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>ips</span><span class=p>,</span> <span class=nx>newIP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nf>inc</span><span class=p>(</span><span class=nx>firstIP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>append</span><span class=p>([]</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span><span class=p>{},</span> <span class=nx>ips</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// inc increments the given IP address by one.
</span></span></span><span class=line><span class=cl><span class=c1>// It handles both IPv4 and IPv6 addresses.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>inc</span><span class=p>(</span><span class=nx>ip</span> <span class=nx>net</span><span class=p>.</span><span class=nx>IP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>j</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ip</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>j</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>j</span><span class=o>--</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ip</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>ip</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The memory leak in this code arises due to a combination of factors. Firstly, each IP address generated within the range is appended to the <code>ips</code> slice using the <code>append</code> function. However, with each append operation, a new copy of the IP address is created using <code>make</code> and <code>copy</code>, resulting in unnecessary memory allocation and consumption.</p><p>Furthermore, the original implementation includes the line <code>append([]net.IP{}, ips...)</code> at the end of the function, which creates a new slice and copies all IP addresses from the <code>ips</code> slice. This duplication further exacerbates the memory usage issue.</p><h1 id=the-solution-utilizing-the-iterator-design-pattern>The Solution: Utilizing the Iterator Design Pattern</h1><p>To address the memory leak issue and optimize the code, we have utilized the Iterator design pattern. This pattern enables us to encapsulate the iteration logic and provide a consistent interface for traversing individual host IP addresses within the specified CIDR range.</p><p>By applying the Iterator design pattern, we achieve a clear separation of concerns, keeping the traversal behavior decoupled from the underlying data structure. This promotes loose coupling and enhances code maintainability, as clients can now access elements sequentially without being exposed to the implementation details of the data structure.</p><p>In our solution, we introduced the <code>HostsIterator</code> struct, which serves as the iterator. It takes responsibility for maintaining the iteration state and provides a method (<code>Next</code>) to advance to the next IP address. By encapsulating the iteration logic within the <code>HostsIterator</code> struct, we adhere to the principles of the Iterator design pattern.</p><p>To ensure an organized codebase, we suggest placing the <code>HostsIterator</code> struct and its associated methods (<code>NewHostsIterator</code> and <code>Next</code>) in a dedicated file or section that focuses specifically on iterator-related functionality. This approach promotes a clear separation of concerns and facilitates easy reuse and future extension of the iterator implementation.</p><p>By leveraging the power of the Iterator design pattern, we enhance the clarity and maintainability of our code. Clients can now seamlessly iterate over host IP addresses within a CIDR range using a consistent and intuitive interface.</p><h2 id=the-iterator-design-pattern>The Iterator Design Pattern</h2><p>The Iterator design pattern is a behavioral design pattern that provides a way to access elements of an aggregate object sequentially without exposing its underlying representation. It separates the traversal behavior from the aggregate object, allowing clients to access elements in a consistent manner without knowing the internal structure of the object.</p><h3 id=key-participants>Key Participants</h3><p>The Iterator design pattern typically involves the following key participants:</p><ul><li><strong>Iterator</strong>: Defines the interface for accessing elements in the collection.</li><li><strong>ConcreteIterator</strong>: Implements the Iterator interface, keeps track of the current position in the collection, and provides methods for traversing the collection.</li><li><strong>Aggregate</strong>: Defines the interface for creating an Iterator object.</li><li><strong>Concrete Aggregate</strong>: Implements the Aggregate interface and returns a ConcreteIterator that traverses the collection.</li></ul><h3 id=benefits-of-the-iterator-design-pattern>Benefits of the Iterator Design Pattern</h3><p>The Iterator design pattern offers several benefits, including:</p><ul><li><strong>Separation of Concerns</strong>: The pattern separates the traversal behavior from the underlying collection, promoting a clear separation of concerns.</li><li><strong>Decoupling</strong>: Clients can iterate over elements without being exposed to the internal structure of the collection, reducing dependencies.</li><li><strong>Flexibility</strong>: It allows for multiple iterators to coexist and iterate over the same collection independently.</li><li><strong>Consistency</strong>: Provides a unified interface for iterating over elements, regardless of the specific collection implementation.</li></ul><h3 id=graph-representation>Graph Representation</h3><p>The following graph illustrates the structure of the Iterator design pattern:</p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR
A[Aggregate] -- creates --&gt; B(Iterator)
B -- uses --&gt; C(ConcreteIterator)
</code></pre><h2 id=the-new-code>The New Code</h2><p><code>HostsIterator</code> represents an iterator for traversing the individual host IP addresses within a given CIDR range.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>HostsIterator</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>IPNet</span>     <span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>IPNet</span>
</span></span><span class=line><span class=cl>	<span class=nx>CurrentIP</span> <span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span>
</span></span><span class=line><span class=cl>	<span class=nx>FirstIP</span>   <span class=nx>net</span><span class=p>.</span><span class=nx>IP</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>NewHostsIterator</code> creates a new HostsIterator instance for the specified CIDR range. It parses the CIDR string, initializes the iterator with the first IP address in the range, and returns a pointer to the HostsIterator.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewHostsIterator</span><span class=p>(</span><span class=nx>cidr</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>HostsIterator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ip</span><span class=p>,</span> <span class=nx>ipNet</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>ParseCIDR</span><span class=p>(</span><span class=nx>cidr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>firstIP</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ip</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nb>copy</span><span class=p>(</span><span class=nx>firstIP</span><span class=p>,</span> <span class=nx>ip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>HostsIterator</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>FirstIP</span><span class=p>:</span>   <span class=nx>firstIP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>IPNet</span><span class=p>:</span>     <span class=nx>ipNet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>CurrentIP</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>Next</code> advances the iterator to the next host IP address. It increments the IP address by one, starting from the least significant byte, until a non-zero value is encountered or the entire address has been traversed. The modified IP address is stored in the HostsIterator&rsquo;s CurrentIP field. The method returns a pointer to the modified IP address.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>n</span> <span class=o>*</span><span class=nx>HostsIterator</span><span class=p>)</span> <span class=nf>Next</span><span class=p>()</span> <span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>currentIp</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>n</span><span class=p>.</span><span class=nx>FirstIP</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nb>copy</span><span class=p>(</span><span class=nx>currentIp</span><span class=p>,</span> <span class=nx>n</span><span class=p>.</span><span class=nx>FirstIP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>currentIp</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>nextIP</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=o>*</span><span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nb>copy</span><span class=p>(</span><span class=nx>nextIP</span><span class=p>,</span> <span class=o>*</span><span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nextIP</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>nextIP</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>nextIP</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>n</span><span class=p>.</span><span class=nx>IPNet</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>nextIP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span> <span class=p>=</span> <span class=nx>nextIP</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>Next2</code> is an optimized version of <code>Next()</code> function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>n</span> <span class=o>*</span><span class=nx>HostsIterator</span><span class=p>)</span> <span class=nf>Next2</span><span class=p>()</span> <span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>currentIP</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>n</span><span class=p>.</span><span class=nx>FirstIP</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nb>copy</span><span class=p>(</span><span class=nx>currentIP</span><span class=p>,</span> <span class=nx>n</span><span class=p>.</span><span class=nx>FirstIP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>currentIP</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>currentIP</span> <span class=o>:=</span> <span class=o>*</span><span class=nx>n</span><span class=p>.</span><span class=nx>CurrentIP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>currentIP</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>currentIP</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>currentIP</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>n</span><span class=p>.</span><span class=nx>IPNet</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>currentIP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>currentIP</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=benchmark-results>Benchmark Results</h1><p>For the purpose of performance evaluation, we have chosen IPv6 as the IP version, specifically utilizing a CIDR of <strong>2001:db8:1::/100</strong>. This CIDR encompasses a total of <strong>268.435.456</strong> hosts, ensuring a substantial amount of data for a reliable assessment of performance.</p><table><thead><tr><th>Function Name</th><th>Execution Count</th><th>Avg Execution Time</th><th>Memory Allocation</th><th>Memory Allocation per Operation</th></tr></thead><tbody><tr><td>GenerateIPListFromCIDRString</td><td>1</td><td>139.9 seconds</td><td>47.5 GB</td><td>268.4 million</td></tr><tr><td>Iterator_Next</td><td>1</td><td>53.8 seconds</td><td>4.3 GB</td><td>268.4 million</td></tr><tr><td>Iterator_Next2</td><td>1</td><td>43.9 seconds</td><td>6.4 GB</td><td>268.4 million</td></tr></tbody></table><h3 id=execution-time>Execution Time</h3><ul><li><strong>Iterator_Next</strong>: 53.8 seconds</li><li><strong>Iterator_Next2</strong>: 43.9 seconds</li><li><strong>GenerateIPListFromCIDRString</strong>: 139.9 seconds</li></ul><p>Based on the execution time, the <strong>Iterator_Next2</strong> function performed the best, followed by <strong>Iterator_Next</strong>, while <strong>GenerateIPListFromCIDRString</strong> had the highest execution time.</p><h3 id=memory-allocation>Memory Allocation</h3><ul><li><strong>Iterator_Next</strong>: 4.3 GB</li><li><strong>Iterator_Next2</strong>: 6.4 GB</li><li><strong>GenerateIPListFromCIDRString</strong>: 47.5 GB</li></ul><p>In terms of memory allocation, the <strong>Iterator_Next</strong> function had the lowest memory allocation, followed by <strong>Iterator_Next2</strong>, whereas <strong>GenerateIPListFromCIDRString</strong> had the highest memory allocation.</p><h3 id=memory-allocation-per-operation>Memory Allocation per Operation</h3><ul><li><strong>Iterator_Next</strong>: 268.4 million</li><li><strong>Iterator_Next2</strong>: 268.4 million</li><li><strong>GenerateIPListFromCIDRString</strong>: 268.4 million</li></ul><p>The number of memory allocations per operation remained consistent for all benchmarks, with each function performing approximately 268.4 million allocations per operation.</p><h3 id=memory-usage>Memory Usage</h3><p>We observed significant differences in memory usage between the <code>GenerateIPListFromCIDR</code> function and the <code>HostsIterator</code>. The <code>GenerateIPListFromCIDR</code> function exhibited high memory usage, consuming approximately <strong>44.26 GB</strong> of memory to store the slice of IPv6 hosts. In contrast, the <code>HostsIterator</code> function demonstrated efficient memory management, utilizing only <strong>3.76 MB</strong>.</p><p>This stark contrast highlights the advantage of using the <code>HostsIterator</code> function over the <code>GenerateIPListFromCIDR</code> function in terms of memory efficiency. By employing the <code>HostsIterator</code> approach, we can significantly reduce memory consumption while effectively handling a large range of IPv6 hosts.</p><ul><li><strong>GenerateIPListFromCIDR</strong></li></ul><p><figure class=gallery-image style=flex-grow:96;flex-basis:230px><a href=/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/20230705_155722.png data-size=962x1000><img src=/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/20230705_155722.png width=962 height=1000 srcset="/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/20230705_155722_hu06fde1e9c02a07f112633a771b85d779_133771_480x0_resize_box_3.png 480w, /p/addressing-the-memory-leak-bug-in-my-personal-project-subping/20230705_155722_hu06fde1e9c02a07f112633a771b85d779_133771_1024x0_resize_box_3.png 1024w" loading=lazy alt="Before optimization"></a><figcaption>Before optimization</figcaption></figure></p><ul><li><strong>Iterator</strong></li></ul><p><figure class=gallery-image style=flex-grow:95;flex-basis:228px><a href=/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/20230705_155739.png data-size=954x1000><img src=/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/20230705_155739.png width=954 height=1000 srcset="/p/addressing-the-memory-leak-bug-in-my-personal-project-subping/20230705_155739_hue6e559f8f25b9c94abcf3a4eca8cbd38_121372_480x0_resize_box_3.png 480w, /p/addressing-the-memory-leak-bug-in-my-personal-project-subping/20230705_155739_hue6e559f8f25b9c94abcf3a4eca8cbd38_121372_1024x0_resize_box_3.png 1024w" loading=lazy alt="After Optimization"></a><figcaption>After Optimization</figcaption></figure></p><p>Based on the benchmark results, the <code>Iterator_Next2</code> function performed the best in terms of execution time, while <code>Iterator_Next</code> had the lowest memory allocation. This highlights the advantages of optimizing memory usage by using appropriate data structures and algorithms, leading to efficient resource utilization within the network package.</p><p>It is important to note that the benchmark results do not directly address the effectiveness of the Iterator design pattern in resolving the memory leak problem. To determine if implementing the Iterator design pattern can solve the issue, further analysis of the code implementation and a detailed understanding of the specific nature of the memory leak would be required.</p><h2 id=references>References</h2><p><a class=link href=https://en.wikipedia.org/wiki/IPv6_address target=_blank rel=noopener>IPv6 address</a></p><p><a class=link href=https://refactoring.guru/design-patterns/iterator target=_blank rel=noopener>Iterator</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/network/>network</a>
<a href=/tags/ping/>ping</a>
<a href=/tags/scanning/>scanning</a></section></footer></article><aside class=related-contents--wrapper></aside><footer class=site-footer><section class=copyright>&copy;
2021 -
2023 Fadhil Yori Hibatullah</section><section class=powerby>Dibangun dengan <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Tema <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> dirancang oleh <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Daftar Isi</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#the-iterator-design-pattern>The Iterator Design Pattern</a><ol><li><a href=#key-participants>Key Participants</a></li><li><a href=#benefits-of-the-iterator-design-pattern>Benefits of the Iterator Design Pattern</a></li><li><a href=#graph-representation>Graph Representation</a></li></ol></li><li><a href=#the-new-code>The New Code</a></li></ol><ol><li><ol><li><a href=#execution-time>Execution Time</a></li><li><a href=#memory-allocation>Memory Allocation</a></li><li><a href=#memory-allocation-per-operation>Memory Allocation per Operation</a></li><li><a href=#memory-usage>Memory Usage</a></li></ol></li><li><a href=#references>References</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>